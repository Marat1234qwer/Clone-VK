{% extends "base.html" %}

{% block title %}–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π ‚Äî Connect{% endblock %}

{% block content %}
<!-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ -->
<div class="post-creator">
    <h3 style="margin-bottom: 16px; color: var(--gray-800);">–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?</h3>
    <form id="postForm" method="POST" action="{{ url_for('create_post') }}">
        <input type="text" name="title" class="form-input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞..." required style="margin-bottom: 12px;">
        <textarea name="content" class="post-input" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –º—ã—Å–ª—è–º–∏..." required></textarea>
        <div class="post-actions">
            <button type="submit" class="post-button">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </form>
</div>

<!-- –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ -->
<div id="postsContainer">
    {% if posts %}
        {% for post in posts %}
        <div class="post">
            <div class="post-header">
                <div class="post-avatar">{{ post[4][0]|upper }}</div>
                <div>
                    <div class="post-author">{{ post[4] }}</div>
                    <div class="post-time">{{ post[3].strftime('%d %b %Y –≤ %H:%M') }}</div>
                </div>
            </div>
            <div class="post-content">
                <h3 class="post-title">{{ post[1] }}</h3>
                <p class="post-text">{{ post[2] }}</p>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="post">
            <div class="post-content" style="text-align: center; padding: 40px;">
                <h3 style="color: var(--gray-400); margin-bottom: 16px;">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</h3>
                <p style="color: var(--gray-400);">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø–æ–¥–µ–ª–∏—Ç—Å—è –Ω–æ–≤–æ—Å—Ç—å—é!</p>
            </div>
        </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script>
    const socket = io();
    
    socket.on('connect', () => {
        console.log('Connected to WebSocket');
        socket.emit('request_feed');
    });
    
    socket.on('feed_update', (data) => {
        const container = document.getElementById('postsContainer');
        container.innerHTML = '';
        
        if (data.posts && data.posts.length > 0) {
            data.posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar">${post.username[0].toUpperCase()}</div>
                        <div>
                            <div class="post-author">${post.username}</div>
                            <div class="post-time">${new Date(post.timestamp).toLocaleString('ru-RU')}</div>
                        </div>
                    </div>
                    <div class="post-content">
                        <h3 class="post-title">${post.title}</h3>
                        <p class="post-text">${post.content}</p>
                    </div>
                    <div class="post-footer">
                        <a href="#" class="post-action">
                            <span>üëç</span>
                            <span>–ù—Ä–∞–≤–∏—Ç—Å—è</span>
                        </a>
                        <a href="#" class="post-action">
                            <span>üí¨</span>
                            <span>–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </a>
                        <a href="#" class="post-action">
                            <span>‚ÜóÔ∏è</span>
                            <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                        </a>
                    </div>
                `;
                container.appendChild(postElement);
            });
        } else {
            container.innerHTML = `
                <div class="post">
                    <div class="post-content" style="text-align: center; padding: 40px;">
                        <h3 style="color: var(--gray-400); margin-bottom: 16px;">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</h3>
                        <p style="color: var(--gray-400);">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø–æ–¥–µ–ª–∏—Ç—Å—è –Ω–æ–≤–æ—Å—Ç—å—é!</p>
                    </div>
                </div>
            `;
        }
    });
    
    socket.on('new_post', (post) => {
        const container = document.getElementById('postsContainer');
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.innerHTML = `
            <div class="post-header">
                <div class="post-avatar">${post.username[0].toUpperCase()}</div>
                <div>
                    <div class="post-author">${post.username}</div>
                    <div class="post-time">${new Date(post.timestamp).toLocaleString('ru-RU')}</div>
                </div>
            </div>
            <div class="post-content">
                <h3 class="post-title">${post.title}</h3>
                <p class="post-text">${post.content}</p>
            </div>
            <div class="post-footer">
                <a href="#" class="post-action">
                    <span>üëç</span>
                    <span>–ù—Ä–∞–≤–∏—Ç—Å—è</span>
                </a>
                <a href="#" class="post-action">
                    <span>üí¨</span>
                    <span>–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                </a>
                <a href="#" class="post-action">
                    <span>‚ÜóÔ∏è</span>
                    <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                </a>
            </div>
        `;
        container.prepend(postElement);
    });
</script>
{% endblock %}